<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>心理咨询系统</title>
    <!-- Bootswatch Cosmo 主题 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/cosmo/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <a class="navbar-brand" href="#">心理咨询中心</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="切换导航">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">首页 <span class="sr-only">(当前)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="articles.html">文章</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="messageWall.html">留言墙</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="consultationLink">心理咨询</a>
                </li>
            </ul>
            <!-- 用户信息区域 -->
            <ul class="navbar-nav ml-auto">
                <li class="nav-item" id="userInfo">
                    <!-- 显示欢迎信息 -->
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">退出登录</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 主体内容放入 main 元素中 -->
    <main>
        <!-- 英雄区 -->
        <header class="jumbotron jumbotron-fluid text-center text-white hero-bg">
            <div class="container">
                <h1 class="display-4">欢迎来到心理咨询中心</h1>
                <p class="lead">在这里，我们关注您的心理健康，陪伴您走过每一个难关</p>
                <a class="btn btn-lg btn-light" href="login.html" role="button">立即登录</a>
            </div>
        </header>

        <!-- 心理语录展示区 -->
        <section class="container my-5">
            <h2 class="mb-4 text-center">今日心理语录</h2>
            <div id="quoteContainer" class="text-center">
                <p id="quoteText">正在加载语录...</p>
            </div>
        </section>


        <!-- 特色内容区：例如精选文章或服务介绍 -->
        <section class="container my-5">
            <h2 class="mb-4 text-center">精选文章</h2>
            <div id="articleList" class="row">
                <!-- 这里将动态生成文章卡片 -->
            </div>
        </section>

        <script>
            // 动态获取精选文章列表（限制返回 3 篇）并生成文章卡片
            fetch('/api/articles?limit=3')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('articleList'); // 修改这里的 id
                    container.innerHTML = '';  // 清空容器内容
                    data.forEach(article => {
                        const cardHTML = `
                                                        <div class="col-md-4">
                                                          <div class="card mb-4">
                                                            <img src="${article.image_url}" class="card-img-top" alt="文章封面">
                                                            <div class="card-body">
                                                              <h5 class="card-title">${article.title}</h5>
                                                              <a href="article.html?id=${article.id}" class="btn btn-primary">阅读全文</a>
                                                            </div>
                                                          </div>
                                                        </div>
                                                      `;
                        container.insertAdjacentHTML('beforeend', cardHTML);
                    });
                })
                .catch(error => console.error('加载文章列表出错:', error));

            // 获取并显示每日心理语录
            fetch('/api/quote')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('quoteText').textContent = data.quote;
                })
                .catch(error => {
                    console.error('加载心理语录失败:', error);
                    document.getElementById('quoteText').textContent = '加载语录失败，请重试';
                });

            //公告
            fetch('/api/announcements')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('announcementsContainer');
                    container.innerHTML = '';  // 清空容器
                    data.forEach(announcement => {
                        // 生成公告显示块
                        const announcementHTML = `
                                            <div class="announcement mb-3">
                                              <h4>${announcement.title}</h4>
                                              <p>${announcement.content}</p>
                                              <small>发布时间：${new Date(announcement.created_at).toLocaleString()}</small>
                                            </div>
                                          `;
                        container.insertAdjacentHTML('beforeend', announcementHTML);
                    });
                })
                .catch(error => console.error('加载公告出错:', error));

            document.addEventListener("DOMContentLoaded", function () {
                // 获取用户角色
                const role = localStorage.getItem('role');

                // 获取心理咨询链接元素
                const consultLink = document.getElementById('consultationLink');

                // 根据角色设置链接
                if (role === '心理医生') {
                    consultLink.href = 'doctorDashboard.html';
                    consultLink.textContent = '医生工作台';
                } else {
                    consultLink.href = 'doctorList.html';
                    consultLink.textContent = '心理咨询';
                }
            });

        </script>
    </main>

    <!-- 页脚放在 main 之外 -->
    <footer class="bg-primary text-white text-center py-3">
        <div class="container">
            <p class="mb-0">&copy; 2025 心理咨询中心. 版权所有.</p>
        </div>
    </footer>

    <!-- 引入 jQuery, Popper.js, Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <script>
        // 检查用户是否已登录
        if (!localStorage.getItem('isLoggedIn')) {
            window.location.href = 'login.html';
        } else {
            const username = localStorage.getItem('username');
            const userInfoElem = document.getElementById('userInfo');
            if (userInfoElem) {
                userInfoElem.innerHTML = `<span class="navbar-text">欢迎, ${username}</span>`;
            }

        }
        // 隐藏英雄区中的“立即登录”按钮
        const heroLoginBtn = document.querySelector('.hero-bg a.btn');
        if (heroLoginBtn) {
            heroLoginBtn.style.display = 'none';
        }
        // 绑定退出登录事件
        document.getElementById('logoutBtn').addEventListener('click', function (e) {
            e.preventDefault();
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 获取今天的日期字符串 (YYYY-MM-DD)
            const today = new Date().toISOString().slice(0, 10);
            // 从 localStorage 获取用户是否选择了今日不再显示公告
            const hideAnnouncement = localStorage.getItem("hideAnnouncementDate");

            // 如果用户已选择不显示且标记为今天，则不显示弹窗
            if (hideAnnouncement === today) {
                return;
            }

            // 调用后端接口获取公告数据（假设返回的是数组）
            fetch("/api/announcements")
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        // 选择最新的一条公告（也可以根据需要选择其它逻辑）
                        const announcement = data[0];
                        // 填充公告内容到模态框
                        document.getElementById("announcementContent").innerHTML = `
                                <h4>${announcement.title}</h4>
                                <p>${announcement.content}</p>
                                <small>发布时间：${new Date(announcement.created_at).toLocaleString()}</small>
                              `;
                        // 使用 jQuery 显示模态框（Bootstrap 4 依赖 jQuery）
                        $("#announcementModal").modal("show");
                    }
                })
                .catch(error => {
                    console.error("加载公告失败:", error);
                });

            // 绑定“不再显示”按钮事件
            document.getElementById("hideAnnouncementBtn").addEventListener("click", function () {
                // 将今天的日期保存到 localStorage 中，表示今日不再显示公告
                localStorage.setItem("hideAnnouncementDate", today);
                $("#announcementModal").modal("hide");
            });
        });
    </script>

    <!-- 公告弹窗模态框 -->
    <div class="modal fade" id="announcementModal" tabindex="-1" role="dialog" aria-labelledby="announcementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="announcementModalLabel">系统公告</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="关闭">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="announcementContent">
                    <!-- 公告内容将通过 JavaScript 加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="hideAnnouncementBtn">今日不再显示</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>